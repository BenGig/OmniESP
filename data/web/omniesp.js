"use strict";var debug=1,log=1;function debugmsg(e){debug&&console.log("DEBUG: "+e)}function logmsg(e){log&&console.log("LOG  : "+e)}function login(){return username=$("#username").val(),password=$("#password").val(),$.ajax({type:"POST",url:"./auth.html",data:"action=login&username="+username+"&password="+password,success:function(e){"true"==e?window.location="/":$("#failed").popup("open")}}),!1}function logout(){return $.ajax({type:"POST",url:"./auth.html",data:"action=logout",success:function(e){window.location="/"}}),!1}function apiCall(e){$("textarea#apiresult").val(""),call(e,showApiCallResult)}function showApiCallResult(e){$("textarea#apiresult").val(e)}var widgets,muteDashboardActions=0;function retrieveDashboard(e){return logmsg("Retrieving dashboard from device..."),call("~/get/ffs/webCFG/root",e)}function dashboardGetWidget(e){switch(widgets.push(e),e.type){case"group":return dashboardGetGroup(e);case"grid":return dashboardGetGrid(e);case"controlgroup":return dashboardGetControlgroup(e);case"text":return dashboardGetText(e);case"button":return dashboardGetButton(e);case"checkbox":return dashboardGetCheckbox(e);case"slider":return dashboardGetSlider(e);default:return logmsg("Unknown widget type "+e.type),""}}function dashboardGetWidgets(e){var t,n="";for(t=0;t<e.length;t++){n+=dashboardGetWidget(e[t])}return n}function dashboardGetGroup(e){var t=e.name;return"\x3c!-- widget: group "+t+'--\x3e\n<div data-role="collapsible" data-inset="true" data-collapsed="false" id="'+t+'"><h2>'+e.caption+"</h2>\n"+dashboardGetWidgets(e.data)+"</div>\n"}function dashboardGetGrid(e){var t,n,o,a=e.name,i=e.data,s=i.length,l=i[1].length,c="\x3c!-- widget: grid "+a+'--\x3e\n<div class="no-margin-grid"><fieldset class="ui-grid-'+String.fromCharCode(95+l)+'">\n';for(t=0;t<s;t++){for(n=0;n<i[t].length;n++)o=a+"-"+t+"-"+n,c+='<div class="ui-block-'+String.fromCharCode(97+n)+'" id="'+o+'">\n'+dashboardGetWidget(i[t][n])+"</div>\n";c+="\n"}return c+="</fieldset></div>\n"}function dashboardGetControlgroup(e){var t,n=e.caption,o=e.name,a=e.data,i=(e.direction,"\x3c!-- widget: controlgroup "+o+' --\x3e\n<div class="ui-field-contain">\n<fieldset data-role="controlgroup" data-type="'+(void 0===e.direction?"horizontal":e.direction)+'" data-mini="true" onChange="dashboardAction(\''+o+"')\">\n<legend>"+n+"</legend>\n");for(t=0;t<a.length;t++){var s=a[t].label,l=a[t].value,c=o+"-"+l;i+='<input name="'+o+'" id="'+c+'" value="'+l+'" type="radio"/>\n',i+='<label for="'+c+'">'+s+"</label>\n"}return i+="</fieldset>\n</div>\n"}function dashboardGetText(e){var t=e.caption,n=e.name,o=(e.data,e.inputtype);o||(o="text");var a=e.readonly,i="\x3c!-- widget: text "+n+' --\x3e\n<div class="ui-field-contain">\n';return t&&(i+='<label for="'+n+'">'+t+"</label>\n"),i+='<input type="'+o+'" data-mini="true" id="'+n+'" value="" '+(a?"readonly ":""),a||(i+="onChange=\"dashboardAction('"+n+"')\""),i+=">\n</div>\n"}function dashboardGetButton(e){var t=e.caption,n=e.name;return"\x3c!-- widget: button "+n+' --\x3e\n<button class="ui-btn ui-btn-inline" onClick="dashboardAction(\''+n+"')\">"+t+"</button>\n"}function dashboardGetCheckbox(e){var t=e.caption,n=e.name;return"\x3c!-- widget: checkbox "+n+' --\x3e\n<input type="checkbox" name="'+n+'" id="'+n+'" onClick="dashboardAction(\''+n+'\')">\n<label for="'+n+'">'+t+"</label>\n"}function dashboardGetSlider(e){var t=e.caption,n=e.name,o=n,a=e.min;void 0===a&&(a=0);var i=e.max;return void 0===i&&(i=99),"\x3c!-- widget: slider "+n+' --\x3e\n<div class="ui-field-contain">\n<label for="'+o+'">'+t+'</label>\n<input type="range" id="'+o+'" min="'+a+'" max="'+i+'" value="'+a+'" onInput="dashboardAction(\''+n+"')\" onChange=\"dashboardAction('"+n+"')\">\n</div>\n"}function dashboardBuild(e){logmsg("Building dashboard..."),debugmsg("json building plan follows..."),debugmsg(e),widgets=[];var t=dashboardGetWidgets(JSON.parse(e));debugmsg("HTML code follows..."),debugmsg(t),$("#dashboard").append(t).trigger("create"),logmsg("Dashboard ready.")}var MIN_MSECS_BETWEEN_CALLS=200,lastCallTime=0,lastTopicsArgs="",delayActive=0;function doCall(){call(lastTopicsArgs),lastCallTime=(new Date).getTime(),delayActive=0}function limitCall(e){if(lastTopicsArgs=e,!delayActive){var t=(new Date).getTime()-lastCallTime;t<MIN_MSECS_BETWEEN_CALLS?(delayActive=1,setTimeout(doCall,MIN_MSECS_BETWEEN_CALLS-t),debugmsg("API call delayed by "+t+" ms.")):(debugmsg("Immediate API call."),doCall())}}function dashboardAction(e){var t;if(!muteDashboardActions)for(t=0;t<widgets.length;t++)if(widgets[t].name==e){var n=widgets[t];if(""!=n.action)switch(n.type){case"controlgroup":var o=getRadio(n.name);n.action&&call(n.action+" "+o),logmsg("controlgroup "+e+" has changed to "+o);break;case"text":logmsg("text "+e+" has changed to "+(o=getText(n.name))),n.action&&call(n.action+" "+o);break;case"button":logmsg("button "+e+" clicked"),n.action&&limitCall(n.action);break;case"checkbox":logmsg("checkbox "+e+" has changed to "+(o=getCheckbox(n.name)?1:0)),n.action&&limitCall(n.action+" "+o);break;case"slider":logmsg("slider "+e+" has changed to "+(o=getText(n.name))),n.action&&limitCall(n.action+" "+o);break;default:logmsg("Unknown widget type "+n.type)}break}}function dashboardEvalEvent(e,t){muteDashboardActions=1;var n,o=e.join("/");for(n=0;n<widgets.length;n++)if(widgets[n].event==o){var a=widgets[n];switch(a.type){case"controlgroup":setRadio(a.name,t);break;case"text":var i="";a.prefix&&(i=a.prefix),i+=t,a.suffix&&(i+=a.suffix),setText(a.name,i);break;case"slider":setText(a.name,t);break;case"checkbox":setCheckbox(a.name,t);break;default:logmsg("Unknown widget type "+a.type)}}muteDashboardActions=0}var connection,withLog=0,mustScroll=[1,1],lines=[0,0],timers=Object.create(null);function consoleSet(e,t){$("#console"+e).html(t)}function consoleScroll(e){var t=$("#console"+e)[0].scrollHeight;$("#console"+e).scrollTop(t)}function consoleWriteln(e,t){var n=new Date;if(lines[e]++,250<lines[e]){var o=$("#console"+e).text();$("#console"+e).text(o.substring(o.indexOf("\n")+1))}$("#console"+e).append(n.toLocaleString()+" "+t+"\n"),mustScroll[e]&&consoleScroll(e)}function consoleClear(e){consoleSet(e,""),lines[e]=0}function consSetScrollFunction(e){mustScroll[e]=1;var t=$("#console"+e);t.scroll(function(){t[0].scrollHeight-t.scrollTop()<=t.outerHeight()+2?mustScroll[e]||(mustScroll[e]=1):mustScroll[e]&&(mustScroll[e]=0)})}function consStart(){logmsg("Starting consoles..."),consSetScrollFunction(0),consSetScrollFunction(1)}function consAddReadings(e){var t=e+"_r",n="<div class='ui-grid-b' id='"+t+"'></div>",o=$("#"+e+" div.ui-collapsible-content").filter(":first").prepend(n);return o.id=t,o}function consColorReading(e,t){$("#"+e+"_t").css("color",t),$("#"+e).css("color",t),$("#"+e+"_v").css("color",t)}function consAddReading(e,t,n){var o="<div class='ui-block-a'><div class='ui-bar ui-bar-a' id='"+t+"_t'>?</div></div><div class='ui-block-b'><div class='ui-bar ui-bar-a' id='"+t+"'>"+n+"</div></div><div class='ui-block-c'><div class='ui-bar ui-bar-a' id='"+t+"_v'>?</div></div>",a=$("#"+e).append(o);return a.id=t,$("#"+e).trigger("refresh"),a}function consSetReading(e,t,n){$("#"+e+"_t").text(t),n?$("#"+e+"_v").text(n):$("#"+e+"_v").html("&nbsp;"),clearTimeout(timers[e]),consColorReading(e,"red"),timers[e]=setTimeout(function(){consColorReading(e,"black")},2500)}function consAddNode(e,t,n){var o="<div data-role='collapsible' data-collapsed='false' id='"+t+"'><h3>"+n+"</h3></div>",a=$("#"+e+" div.ui-collapsible-content").filter(":first").append(o);return a.id=t,a.trigger("create"),a}function consEvalEvent(e,t,n){var o,a="readings";for(o=2;o<t.length;o++){var i=t[o],s=a;if(a+="_"+i,null==document.getElementById(a))if(o<t.length-1)consAddNode(s,a,i);else{var l=s+"_r";null==document.getElementById(l)&&consAddReadings(s),consAddReading(l,a,i)}o==t.length-1&&consSetReading(a,e,n)}}function showDetails(e,t,n){var o=$("#"+e);t.val().match(n)?o.show():o.hide()}function setRadioHandlers(){logmsg("Setting radio handlers..."),$(document).on("change","input[name=wifi]",function(){showDetails("wifi_net_details",$(this),"manual"),showDetails("wifi_details",$(this),"dhcp|manual")}),$(document).on("change","input[name=lan]",function(){showDetails("lan_net_details",$(this),"manual")}),$(document).on("change","input[name=ntp]",function(){showDetails("ntp_details",$(this),"on")}),$(document).on("change","input[name=mqtt]",function(){showDetails("mqtt_details",$(this),"on")}),$(document).on("change","input[name=ap]",function(){showDetails("ap_details",$(this),"on|auto")})}function ping(){$.ajax({url:"/",success:function(e){startOver()}})}function reloadIfAlive(){logmsg("reload if alive..."),setInterval(ping,3e3)}function reboot(){$("#popupRebooting").popup("open"),call("~/set/esp/restart"),reloadIfAlive()}function setTime(){call("~/set/clock/forceNTPUpdate")}function update(){call("~/set/esp/update")}function update(){logmsg("update call"),$.post("/api.html","call=~/set/esp/update",function(e,t){logmsg("update result: "+e),"ok"==e?$("#popupUpdateOk").popup("open"):($("#update_error").html(e),$("#popupUpdateFail").popup("open"))})}function upload(){var e=$("#update_localpath").prop("files")[0];e&&(logmsg("Uploading "+e.name+" ("+e.size+" bytes)"),$.mobile.loading("show",{text:"uploading tarball...",textVisible:!0,textonly:!1}),$.ajax({type:"POST",url:"/upload.html",cache:!1,contentType:!1,processData:!1,timeout:6e4,data:new FormData($("#upload_form")[0]),error:function(){$.mobile.loading("hide"),$("#upload_error").html("upload timed out"),$("#popupUploadFail").popup("open")},success:function(e){$.mobile.loading("hide"),logmsg("upload result: "+e),"ok"==e?$("#popupUploadOk").popup("open"):($("#upload_error").html(e),$("#popupUploadFail").popup("open"))}}))}function call(e,n){logmsg("API async call "+e),$.post("/api.html","call="+e,function(e,t){logmsg("API async result: "+e),n&&n(e)},"text").fail(function(){startOver()})}function retrieveConfig(e){return logmsg("Retrieving configuration from device..."),call("~/get/ffs/cfg/root",e)}function saveConfig(){logmsg("Saving configuration in device..."),call("~/set/ffs/cfg/saveFile")}function sendConfig(e){logmsg("Sending configuration to device..."),call("~/set/ffs/cfg/root "+e,saveConfig)}function setText(e,t){$("#"+e).filter(":input").val(t)}function setRadio(e,t){var n=$('input:radio[name="'+e+'"]'),o=n.filter('[value="'+t+'"]');o.prop("checked",!0),n.checkboxradio("refresh"),o.trigger("change")}function setCheckbox(e,t){$('input:checkbox[name="'+e+'"]').prop("checked",1==t).checkboxradio("refresh")}function setConfig(e){logmsg("Setting inputs from configuration...");var t=JSON.parse(e),n=$("#config");n.find("input:text").val(function(){return t[this.name]}),n.find("input:password").val(function(){return t[this.name]}),setRadio("wifi",t.wifi),setRadio("lan",t.lan),setRadio("ntp",t.ntp),setRadio("update",t.update),setRadio("mqtt",t.mqtt),setRadio("ap",t.ap)}function getRadio(e){return $('input:radio[name="'+e+'"]:checked').val()}function getCheckbox(e){return $('input:checkbox[name="'+e+'"]').is(":checked")}function getText(e,t){return $("#"+e).filter(":input").val()}function getConfig(){logmsg("Getting configuration from inputs...");var e={},t=$("#config");return t.find("input:text").each(function(){e[$(this).attr("id")]=$(this).val()}),t.find("input:password").each(function(){e[$(this).attr("id")]=$(this).val()}),e.wifi=getRadio("wifi"),e.lan=getRadio("lan"),e.ntp=getRadio("ntp"),e.update=getRadio("update"),e.mqtt=getRadio("mqtt"),e.ap=getRadio("ap"),JSON.stringify(e)}function apply(){sendConfig(getConfig())}function startOver(){closeConnection(),window.location.href="/"}function message(e){debugmsg(window.status=e)}function message_clear(){message("")}$(document).ready(function(){logmsg("Document loaded.")}),$(document).on("pagecreate","#page1",function(e,t){logmsg("Page 1 created."),consStart(),startListener(),logmsg("Initializing dashboard...");retrieveDashboard(dashboardBuild)}),$(document).on("pagecreate","#page2",function(e,t){logmsg("Page 2 created."),logmsg("Initializing configuration page..."),setRadioHandlers();retrieveConfig(setConfig)});var lastIndex=0;function startListener(){logmsg("Opening connection..."),setTimeout(openConnection,1e3)}function openConnection(){message_clear();var e="ws://"+window.location.href.split("/")[2]+"/ws";connection&&connection.close(),logmsg("Connecting to "+e+"..."),(connection=new WebSocket(e)).onclose=connection.onerror=connection.onmessage=updateListener}function closeConnection(){connection&&("function"==typeof connection.close?connection.close():"function"==typeof connection.abort&&connection.abort(),connection=void 0)}function updateListener(e){var t="Connection lost, trying to reconnect every 5 seconds.",n="";if(("function"==typeof WebSocket||"object"==typeof WebSocket)&&e&&e.target instanceof WebSocket){if("close"==e.type)return message(t),closeConnection(),void setTimeout(openConnection,5e3);n=e.data,lastIndex=0}else{if(4==connection.readyState)return message(t),void setTimeout(openConnection,5e3);if(3!=connection.readyState)return;var o=connection.responseText.length;if(lastIndex==o)return;n=connection.responseText.substring(lastIndex,o),lastIndex=o}null!=n&&0!=n.length&&(message("data received"),dispatchContent(n))}function dispatchContent(e){var t=JSON.parse(e);if("event"==t.type){consoleWriteln(0,t.value);var n=new Date,o=t.value.split(" "),a=o[0].split("/");a.shift(),a.unshift("~"),o.shift();var i=0<o.length?o.join(" "):"";consEvalEvent(n.toLocaleString(),a,i),dashboardEvalEvent(a,i)}else"log"==t.type&&consoleWriteln(1,t.subtype+" "+t.value)}